<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goods Page</title>
    <link rel="stylesheet" href="/css/slick.css">
    <link rel="stylesheet" href="/css/slick-theme.css">
    <link rel="stylesheet" href="/css/usedgoodspage.css">
</head>
<body>
    <header>
        <div class="header">
            <div class="logo">
                <img src="images/logo noback.png" alt="logo">
            </div>
            <div class="header_bar">
                <div class="search">
                    <div id="suggestions"></div>
                    <input type="text" id="search" placeholder="Search..." class="search">
                    <button class="search_button" name="search"></button>
                    <img src="/images/magnifying-glass-dollar-solid.svg" alt="Search">
                </div>
                <div class="nav_bar">
                    <div class="head">
                        <a href="home">Home</a>
                        <a href="goodspage">一般商城</a>
                        <a href="usedgoodspage">二手商城</a>
                        <a href="#contact">品牌</a>
                    </div>
                </div>
            </div>
            <div class="icon_area">
                <div class="icons">
                    <a href="member"><img src="images/會員中心.png" alt="User"></a>
                    <a href="/mem/login"><img src="images/log-in.png" alt="Login"></a>
                    <a href="#"><img src="images/聊天室(FAQ 客服).png" alt="Chat"></a>
                    <a href="#"><img src="images/購物車.png" alt="Cart"></a>
                </div>
                <div class="coupon_area">
                    <a class="coupon" href="#"><img src="images/優惠卷領取頁面圖示.png" alt="coupon"></a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="goods_body">
        <div class="goods_list">
            <p><b>商品分類</b></p>
            <ul>
                <li th:each="gg : ${glist}">
                    <p th:attr="data-goodstNo=${gg.goodstNo}" onclick="filterGoods(this)" th:text="${gg.goodstName}"></p>
                </li>
            </ul>
        </div>

        <!-- 商品顯示區域 -->
        <div class="bestsell_goods" id="goodsContainer">
            <div class="goods" th:each="used : ${list}" data-goodstNo="${used.usedNo}">
                <div th:each="usedgoods,iterStat : ${used.usedPics}">
                    <div th:if="${iterStat.index == 0}" class="image-container">
                        <a th:href="@{/used/getOneUsedOnDetail(usedNo=${used.usedNo})}">
                            <img th:src="@{/usedpic/UsedDBGifReader} + '?usedPicNo=' + ${usedgoods.usedPicNo}" alt="goods-image" />
                        </a>
                    </div>
                </div>
                <div class="goods-name">
                    <label th:text="${used.usedName}"></label>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div>© 2024 DO BUY. All Rights Reserved.</div>
    </footer>

    <script src="/js/jquery3.7.1.js"></script>
    <script src="/js/slick.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.8/axios.min.js"
        integrity="sha512-v8+bPcpk4Sj7CKB11+gK/FnsbgQ15jTwZamnBf/xDmiQDcgOIYufBo6Acu1y30vrk8gg5su4x0CG3zfPaq5Fcg=="
        crossorigin="anonymous"></script>

    <script>
    function filterGoods(element) {
        const goodstNo = element.getAttribute('data-goodstNo');
        if (!goodstNo) {
            console.error('goodstNo is missing or invalid');
            return;
        }

        fetch(`/usedgoods/filter?goodstNo=${goodstNo}`)
            .then(response => response.json())
            .then(data => {
                const goodsContainer = document.getElementById('goodsContainer');
                goodsContainer.innerHTML = '';  // 清空現有商品
                if (data.length === 0) {
                    goodsContainer.innerHTML = '<p>沒有找到符合的商品</p>';
                } else {
                    data.forEach(goods => {
                        const goodsElement = document.createElement('div');
                        goodsElement.className = 'goods';

                        // 創建表單並設置 action
                        const formElement = document.createElement('form');
                        formElement.action = '/used/getOneUsedOnDetail'; // 商品詳細頁面
                        formElement.method = 'get';

                        // 創建 hidden input，包含商品編號
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'usedNo'; // 使用商品的 usedNo
                        hiddenInput.value = goods.usedNo;

                        // 創建提交按鈕
                        const buttonElement = document.createElement('button');
                        buttonElement.type = 'submit';
                        buttonElement.className = 'product-button';

                        // 顯示商品的圖片和名稱
                        const firstPic = goods.usedPics && goods.usedPics.length > 0 ? goods.usedPics[0] : '';
                        buttonElement.innerHTML = `
                            <div class="image-container">
                                <img src="/usedpic/UsedDBGifReader?usedPicNo=${firstPic}" alt="goods-image">
                            </div>
                            <div class="goods-name">
                                <label>${goods.usedName}</label>
                            </div>
                        `;

                        // 將 hidden input 和按鈕加入表單
                        formElement.appendChild(hiddenInput);
                        formElement.appendChild(buttonElement);

                        // 將表單加入商品元素
                        goodsElement.appendChild(formElement);

                        // 將商品元素加入商品容器
                        goodsContainer.appendChild(goodsElement);
                    });
                }
            })
            .catch(error => console.error('Error fetching goods:', error));
    }

    // 獲取搜尋框（searchBar）和建議框（suggestionsBox）
    const searchBar = document.getElementById('search');
    const suggestionsBox = document.getElementById('suggestions');

    // 監聽搜尋框的鍵盤事件
    searchBar.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();  // 防止表單提交
            const query = searchBar.value.trim();
            if (query.length > 0) {
                // 根據搜尋條件過濾商品
                filterGoodsBySearch(query);
            }
            searchBar.value = '';           // 清空搜尋框
            suggestionsBox.innerHTML = '';  // 清空建議框
            suggestionsBox.style.display = 'none';
        }
    });

    // 根據搜尋條件過濾商品
    function filterGoodsBySearch(query) {
        const goodsContainer = document.getElementById('goodsContainer');
        const goodsElements = goodsContainer.getElementsByClassName('goods');

        // 遍歷所有商品，根據名稱或編號進行比對
        Array.from(goodsElements).forEach(goodsElement => {
            const productName = goodsElement.querySelector('.goods-name label').textContent.trim().toLowerCase();
            const productNo = goodsElement.getAttribute('data-goodstNo');  // 假設商品編號放在 data-goodstNo 屬性中

            // 根據名稱或編號進行比對
            if (productName.includes(query.toLowerCase()) || productNo.includes(query)) {
                goodsElement.style.display = 'block';  // 顯示匹配的商品
            } else {
                goodsElement.style.display = 'none';   // 隱藏不匹配的商品
            }
        });
    }

    // 防抖動函數
    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func(...args);
            }, delay);
        };
    }

    // 搜尋建議處理函數
    async function handleSearch() {
        const query = searchBar.value.trim();
        if (query.length < 1) {
            suggestionsBox.innerHTML = ''; // 清空建議
            suggestionsBox.style.display = 'none'; // 隱藏建議框
            return;
        }

        try {
            const response = await axios.get(`/searchused`, { params: { query } });
            let products = response.data;

            // 檢查產品是否為空
            if (!Array.isArray(products) || products.length === 0) {
                suggestionsBox.innerHTML = '<div>沒有找到相關商品</div>';
                suggestionsBox.style.display = 'block';
                return;
            }

            // 根據商品名稱中搜尋字詞的匹配度來排序
            products = products.sort((a, b) => {
                const queryLower = query.toLowerCase();
                const aIndex = a.usedName.toLowerCase().indexOf(queryLower);
                const bIndex = b.usedName.toLowerCase().indexOf(queryLower);
                if (aIndex === 0 && bIndex !== 0) return -1;
                if (bIndex === 0 && aIndex !== 0) return 1;
                return aIndex - bIndex;
            });

            suggestionsBox.innerHTML = '';
            if (products.length > 0) {
                suggestionsBox.style.display = 'block';
            } else {
                suggestionsBox.style.display = 'none';
            }

            // 處理產品列表，生成建議項
            products.forEach(product => {
                const div = document.createElement('div');
                div.classList.add('suggestion');
                div.textContent = product.usedName; // 假設商品有 usedName 屬性
                div.addEventListener('click', () => {
                    searchBar.value = product.usedName; // 選中商品
                    suggestionsBox.innerHTML = ''; // 清空建議
                    suggestionsBox.style.display = 'none'; // 隱藏建議框
                    const targetUrl = `/used/getOneUsedOnDetail?usedNo=${encodeURIComponent(product.usedNo)}`;

                    // 跳轉到商品詳細頁面
                    window.location.href = targetUrl;
                });
                suggestionsBox.appendChild(div);    
            });
        } catch (error) {
            console.error('獲取建議時發生錯誤:', error);
            suggestionsBox.innerHTML = '<div>發生錯誤，請稍後重試。</div>';
            suggestionsBox.style.display = 'block';
        }
    }

    // 將搜尋函數應用防抖動，並設置延遲（例如：300 毫秒）
    const debouncedSearch = debounce(handleSearch, 300);

    // 監聽搜尋框的輸入事件
    searchBar.addEventListener('input', debouncedSearch);
    </script>
</body>
</html>
